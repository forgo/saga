name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.24'
  SURREALDB_VERSION: '3.0.0-beta.3'
  MIN_COVERAGE: 11

jobs:
  # Detect which paths changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      ios: ${{ steps.filter.outputs.ios }}
      admin: ${{ steps.filter.outputs.admin }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'api/**'
              - '.github/workflows/ci.yml'
            ios:
              - 'ios/**'
              - '.github/workflows/ci.yml'
            admin:
              - 'admin/**'
              - '.github/workflows/ci.yml'

  api:
    name: API
    needs: changes
    if: needs.changes.outputs.api == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./api
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: api/go.sum

      - name: Start SurrealDB
        run: |
          docker run -d --name surrealdb -p 8000:8000 \
            surrealdb/surrealdb:v${{ env.SURREALDB_VERSION }} \
            start --user root --pass root --bind 0.0.0.0:8000 memory
          sleep 5
          curl -f http://localhost:8000/health || exit 1
        working-directory: .

      - name: Lint
        uses: golangci/golangci-lint-action@v9
        with:
          working-directory: ./api
          version: v2.10.1

      - name: Test with Coverage
        run: |
          go test -v -race -timeout 15m -coverprofile=coverage.out -covermode=atomic ./...
          go tool cover -func=coverage.out
        env:
          DB_HOST: localhost
          DB_PORT: 8000
          DB_USER: root
          DB_PASSWORD: root
          DB_NAMESPACE: saga
          DB_DATABASE: test

      - name: Check Coverage Threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < ${{ env.MIN_COVERAGE }}" | bc -l) )); then
            echo "Coverage ${COVERAGE}% is below minimum threshold of ${{ env.MIN_COVERAGE }}%"
            exit 1
          fi

      - name: Upload Coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./api/coverage.out
          flags: api
          fail_ci_if_error: false
        continue-on-error: true

      - name: Build
        run: go build -o server ./cmd/server

  ios:
    name: iOS
    needs: changes
    # Run iOS tests if iOS OR API changed (API changes could break iOS)
    if: needs.changes.outputs.ios == 'true' || needs.changes.outputs.api == 'true'
    runs-on: macos-14
    defaults:
      run:
        working-directory: ./ios/Saga
    steps:
      - uses: actions/checkout@v6

      - name: Cache Swift packages
        uses: actions/cache@v5
        with:
          path: ios/Saga/.build
          key: swift-${{ hashFiles('**/Package.resolved') }}
          restore-keys: swift-

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.1.app

      - name: List Available Simulators
        run: xcrun simctl list devices available | grep -E "iPhone|iPad" | head -20

      - name: Build and Test
        run: |
          xcodebuild test \
            -project Saga.xcodeproj \
            -scheme Saga \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
            -only-testing:SagaTests \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGNING_ALLOWED=NO

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: ios-test-results
          path: ios/Saga/TestResults.xcresult

  admin:
    name: Admin
    needs: changes
    if: needs.changes.outputs.admin == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./admin
    steps:
      - uses: actions/checkout@v6

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Cache Deno dependencies
        uses: actions/cache@v5
        with:
          path: ~/.cache/deno
          key: deno-${{ hashFiles('admin/deno.lock') }}
          restore-keys: deno-

      - name: Install dependencies
        run: deno install

      - name: Lint
        run: deno lint

      - name: Format check
        run: deno fmt --check .

      - name: Type check
        run: deno check main.ts

      - name: Test
        run: deno test --allow-all

      - name: Build
        run: deno task build
