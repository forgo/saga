name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.24'
  SURREALDB_VERSION: '3.0.0-beta.1'
  MIN_COVERAGE: 12

jobs:
  # Detect which paths changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      ios: ${{ steps.filter.outputs.ios }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'api/**'
              - '.github/workflows/ci.yml'
            ios:
              - 'ios/**'
              - '.github/workflows/ci.yml'

  api:
    name: API
    needs: changes
    if: needs.changes.outputs.api == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./api
    steps:
      - uses: actions/checkout@v4

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: go-${{ hashFiles('api/go.sum') }}
          restore-keys: go-

      - name: Start SurrealDB
        run: |
          docker run -d --name surrealdb -p 8000:8000 \
            surrealdb/surrealdb:v${{ env.SURREALDB_VERSION }} \
            start --user root --pass root --bind 0.0.0.0:8000 memory
          sleep 5
          curl -f http://localhost:8000/health || exit 1
        working-directory: .

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Lint
        uses: golangci/golangci-lint-action@v4
        with:
          working-directory: ./api
          version: latest
          args: --timeout=5m

      - name: Test with Coverage
        run: |
          go test -v -race -timeout 15m -coverprofile=coverage.out -covermode=atomic ./...
          go tool cover -func=coverage.out
        env:
          DB_HOST: localhost
          DB_PORT: 8000
          DB_USER: root
          DB_PASSWORD: root
          DB_NAMESPACE: saga
          DB_DATABASE: test

      - name: Check Coverage Threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < ${{ env.MIN_COVERAGE }}" | bc -l) )); then
            echo "Coverage ${COVERAGE}% is below minimum threshold of ${{ env.MIN_COVERAGE }}%"
            exit 1
          fi

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./api/coverage.out
          flags: api
          fail_ci_if_error: false
        continue-on-error: true

      - name: Build
        run: go build -o server ./cmd/server

  ios:
    name: iOS
    needs: changes
    # Run iOS tests if iOS OR API changed (API changes could break iOS)
    if: needs.changes.outputs.ios == 'true' || needs.changes.outputs.api == 'true'
    runs-on: macos-14
    defaults:
      run:
        working-directory: ./ios/Saga
    steps:
      - uses: actions/checkout@v4

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: ios/Saga/.build
          key: swift-${{ hashFiles('**/Package.resolved') }}
          restore-keys: swift-

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.1.app

      - name: List Available Simulators
        run: xcrun simctl list devices available | grep -E "iPhone|iPad" | head -20

      - name: Build and Test
        run: |
          xcodebuild test \
            -project Saga.xcodeproj \
            -scheme Saga \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
            -only-testing:SagaTests \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGNING_ALLOWED=NO

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: ios-test-results
          path: ios/Saga/TestResults.xcresult
