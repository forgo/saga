# Auth endpoints

register:
  post:
    summary: Register new user
    description: Create a new user account with email and password
    operationId: register
    tags: [auth]
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/_index.yaml#/RegisterRequest'
    responses:
      '201':
        description: User created successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    user:
                      $ref: '../components/schemas/_index.yaml#/User'
                    token:
                      $ref: '../components/schemas/_index.yaml#/TokenResponse'
      '409':
        description: Email already registered
        content:
          application/problem+json:
            schema:
              $ref: '../components/schemas/_index.yaml#/ProblemDetails'
      '422':
        description: Validation error
        content:
          application/problem+json:
            schema:
              $ref: '../components/schemas/_index.yaml#/ProblemDetails'

login:
  post:
    summary: Login with email/password
    operationId: login
    tags: [auth]
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/_index.yaml#/LoginRequest'
    responses:
      '200':
        description: Login successful
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    user:
                      $ref: '../components/schemas/_index.yaml#/User'
                    token:
                      $ref: '../components/schemas/_index.yaml#/TokenResponse'
      '401':
        description: Invalid credentials
        content:
          application/problem+json:
            schema:
              $ref: '../components/schemas/_index.yaml#/ProblemDetails'

oauth-google:
  post:
    summary: Authenticate with Google
    description: Exchange Google OAuth authorization code for tokens
    operationId: oauthGoogle
    tags: [auth]
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/_index.yaml#/OAuthRequest'
    responses:
      '200':
        description: Authentication successful
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    user:
                      $ref: '../components/schemas/_index.yaml#/User'
                    token:
                      $ref: '../components/schemas/_index.yaml#/TokenResponse'
                    is_new_user:
                      type: boolean
      '400':
        description: OAuth error
        content:
          application/problem+json:
            schema:
              $ref: '../components/schemas/_index.yaml#/ProblemDetails'

oauth-apple:
  post:
    summary: Authenticate with Apple
    description: Exchange Apple OAuth authorization code for tokens
    operationId: oauthApple
    tags: [auth]
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/_index.yaml#/OAuthRequest'
    responses:
      '200':
        description: Authentication successful
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    user:
                      $ref: '../components/schemas/_index.yaml#/User'
                    token:
                      $ref: '../components/schemas/_index.yaml#/TokenResponse'
                    is_new_user:
                      type: boolean
      '400':
        description: OAuth error
        content:
          application/problem+json:
            schema:
              $ref: '../components/schemas/_index.yaml#/ProblemDetails'

passkey-register-start:
  post:
    summary: Start passkey registration
    description: Get WebAuthn challenge and options for registering a new passkey
    operationId: passkeyRegisterStart
    tags: [auth]
    security:
      - bearerAuth: []
    responses:
      '200':
        description: Registration options
        content:
          application/json:
            schema:
              $ref: '../components/schemas/_index.yaml#/PasskeyRegistrationStartResponse'
      '401':
        description: Not authenticated
        content:
          application/problem+json:
            schema:
              $ref: '../components/schemas/_index.yaml#/ProblemDetails'

passkey-register-finish:
  post:
    summary: Complete passkey registration
    description: Submit WebAuthn attestation to finish registering a passkey
    operationId: passkeyRegisterFinish
    tags: [auth]
    security:
      - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/_index.yaml#/PasskeyRegistrationFinishRequest'
    responses:
      '201':
        description: Passkey registered
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  $ref: '../components/schemas/_index.yaml#/Passkey'
      '400':
        description: Invalid attestation
        content:
          application/problem+json:
            schema:
              $ref: '../components/schemas/_index.yaml#/ProblemDetails'

passkey-login-start:
  post:
    summary: Start passkey login
    description: Get WebAuthn challenge for authenticating with a passkey
    operationId: passkeyLoginStart
    tags: [auth]
    security: []
    requestBody:
      content:
        application/json:
          schema:
            $ref: '../components/schemas/_index.yaml#/PasskeyLoginStartRequest'
    responses:
      '200':
        description: Authentication options
        content:
          application/json:
            schema:
              $ref: '../components/schemas/_index.yaml#/PasskeyLoginStartResponse'

passkey-login-finish:
  post:
    summary: Complete passkey login
    description: Submit WebAuthn assertion to authenticate with a passkey
    operationId: passkeyLoginFinish
    tags: [auth]
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/_index.yaml#/PasskeyLoginFinishRequest'
    responses:
      '200':
        description: Login successful
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    user:
                      $ref: '../components/schemas/_index.yaml#/User'
                    token:
                      $ref: '../components/schemas/_index.yaml#/TokenResponse'
      '400':
        description: Invalid assertion
        content:
          application/problem+json:
            schema:
              $ref: '../components/schemas/_index.yaml#/ProblemDetails'

refresh:
  post:
    summary: Refresh access token
    description: Exchange a refresh token for new access and refresh tokens
    operationId: refreshTokens
    tags: [auth]
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/_index.yaml#/RefreshRequest'
    responses:
      '200':
        description: Tokens refreshed
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  $ref: '../components/schemas/_index.yaml#/TokenResponse'
      '401':
        description: Invalid or expired refresh token
        content:
          application/problem+json:
            schema:
              $ref: '../components/schemas/_index.yaml#/ProblemDetails'

logout:
  post:
    summary: Logout
    description: Revoke all refresh tokens for the current user
    operationId: logout
    tags: [auth]
    security:
      - bearerAuth: []
    responses:
      '204':
        description: Logged out successfully
      '401':
        description: Not authenticated
        content:
          application/problem+json:
            schema:
              $ref: '../components/schemas/_index.yaml#/ProblemDetails'

me:
  get:
    summary: Get current user
    description: Get the authenticated user's profile, identities, and passkeys
    operationId: getCurrentUser
    tags: [auth]
    security:
      - bearerAuth: []
    responses:
      '200':
        description: User profile
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  $ref: '../components/schemas/_index.yaml#/UserWithIdentities'
      '401':
        description: Not authenticated
        content:
          application/problem+json:
            schema:
              $ref: '../components/schemas/_index.yaml#/ProblemDetails'

link:
  post:
    summary: Link OAuth provider
    description: Link a new OAuth identity to the current account
    operationId: linkProvider
    tags: [auth]
    security:
      - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/_index.yaml#/OAuthRequest'
    responses:
      '200':
        description: Provider linked
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  $ref: '../components/schemas/_index.yaml#/Identity'
      '409':
        description: Identity already linked to another account
        content:
          application/problem+json:
            schema:
              $ref: '../components/schemas/_index.yaml#/ProblemDetails'

passkey-delete:
  delete:
    summary: Delete passkey
    description: Remove a registered passkey
    operationId: deletePasskey
    tags: [auth]
    security:
      - bearerAuth: []
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    responses:
      '204':
        description: Passkey deleted
      '404':
        description: Passkey not found
        content:
          application/problem+json:
            schema:
              $ref: '../components/schemas/_index.yaml#/ProblemDetails'
