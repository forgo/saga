#!/usr/bin/env bash
# Pre-commit hook: runs linters on staged changes.
# Bypass with: git commit --no-verify
set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

FAILED=0

# Get repo root
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Detect which files have staged changes
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

HAS_GO=0
HAS_DENO=0

for file in $STAGED_FILES; do
    case "$file" in
        api/*.go) HAS_GO=1 ;;
        admin/*) HAS_DENO=1 ;;
    esac
done

if [[ $HAS_GO -eq 0 && $HAS_DENO -eq 0 ]]; then
    exit 0
fi

echo "Running pre-commit checks..."
echo ""

# ── Go checks ──────────────────────────────────────────────────────────
if [[ $HAS_GO -eq 1 ]]; then
    echo -e "${YELLOW}[go]${NC} Checking Go code..."

    # Lint (only new/changed code relative to HEAD)
    if command -v golangci-lint &> /dev/null; then
        if ! (cd "$REPO_ROOT/api" && golangci-lint run --new-from-rev=HEAD ./...); then
            echo -e "${RED}[go]${NC} Lint failed"
            FAILED=1
        else
            echo -e "${GREEN}[go]${NC} Lint passed"
        fi
    else
        echo -e "${YELLOW}[go]${NC} golangci-lint not found — run 'make -C api tools' to install"
        FAILED=1
    fi

    # Format check
    UNFORMATTED=$(cd "$REPO_ROOT/api" && gofmt -l . 2>/dev/null || true)
    if [[ -n "$UNFORMATTED" ]]; then
        echo -e "${RED}[go]${NC} Files need formatting (run 'gofmt -w .'):"
        echo "$UNFORMATTED" | sed 's/^/  /'
        FAILED=1
    else
        echo -e "${GREEN}[go]${NC} Format check passed"
    fi
fi

# ── Deno checks ────────────────────────────────────────────────────────
if [[ $HAS_DENO -eq 1 ]]; then
    echo -e "${YELLOW}[admin]${NC} Checking admin code..."

    if command -v deno &> /dev/null; then
        # Lint
        if ! (cd "$REPO_ROOT/admin" && deno lint); then
            echo -e "${RED}[admin]${NC} Lint failed"
            FAILED=1
        else
            echo -e "${GREEN}[admin]${NC} Lint passed"
        fi

        # Format check
        if ! (cd "$REPO_ROOT/admin" && deno fmt --check .); then
            echo -e "${RED}[admin]${NC} Format check failed (run 'deno fmt .')"
            FAILED=1
        else
            echo -e "${GREEN}[admin]${NC} Format check passed"
        fi
    else
        echo -e "${YELLOW}[admin]${NC} deno not found — skipping admin checks"
    fi
fi

# ── Result ─────────────────────────────────────────────────────────────
echo ""
if [[ $FAILED -eq 1 ]]; then
    echo -e "${RED}Pre-commit checks failed.${NC} Fix the issues above and try again."
    echo "To bypass: git commit --no-verify"
    exit 1
fi

echo -e "${GREEN}All pre-commit checks passed.${NC}"
